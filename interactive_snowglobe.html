<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Секретный Снеговик — Тайный Санта</title>
  <style>
    :root{
      --bg: #071228;
      --card: linear-gradient(180deg,#0b2b4a 0%, #07203a 100%);
      --glass-size: min(78vmin,420px);
      --snow-size: calc(var(--glass-size) * 0.98);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color: #e6eef8;
    }
    html,body{height:100%;margin:0}
    body{
      display:flex;align-items:center;justify-content:center;
      background: radial-gradient(circle at 10% 10%, #0b2a4a 0%, var(--bg) 30%), #021220;
      padding:24px;box-sizing:border-box;
    }

    /* layout: single column (removed right-panel) */
    .wrap{
      width:100%;max-width:980px;display:block;
    }

    .card{
      background:var(--card);border-radius:16px;padding:24px;box-shadow:0 8px 30px rgba(2,8,23,0.6);min-height:420px;
      display:flex;flex-direction:column;align-items:center;
    }

    h1{margin:0 0 12px 0;font-size:20px}
    p.lead{margin:0 0 18px 0;opacity:0.9}

    /* Globe area */
    .globe-stage{display:flex;align-items:center;justify-content:center;padding:14px;width:100%}
    .globe{
      width:var(--glass-size);height:var(--glass-size);position:relative;border-radius:50%;overflow:hidden;
      display:flex;align-items:center;justify-content:center;backdrop-filter:blur(2px);
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.06), rgba(255,255,255,0.02) 20%), rgba(255,255,255,0.02);
      box-shadow: inset 0 -14px 30px rgba(2,4,10,0.6), 0 12px 40px rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.06);
    }

    /* inner content where images will be shown
       we reserve an inner square that is guaranteed to fit fully inside the circle.
       The largest axis-aligned rectangle that fits inside a circle of diameter D has max side = D / sqrt(2) (~0.707D).
       To be safe and give some padding we use 70% (0.7) of the globe diameter.
    */
    .globe-inner{
      position:relative;
      width:70%;
      height:70%;
      display:flex;
      align-items:center;
      justify-content:center;
      /* no overflow hidden here — image will be sized to fit inside this box */
    }

    /* Ensure the image is fully visible: object-fit:contain and limit to inner box */
    .globe-inner img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      transition:opacity .4s ease, transform .6s cubic-bezier(.2,.9,.2,1);
      border-radius:6px; /* small rounding for nicer look inside globe */
      box-shadow: 0 6px 18px rgba(0,0,0,0.35) inset;
      pointer-events:none;
    }

    /* snow layer */
    .snow-layer{pointer-events:none;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:var(--snow-size);height:var(--snow-size);overflow:hidden}
    .flake{position:absolute;top:-10%;left:0;width:6px;height:6px;border-radius:50%;opacity:.9;animation:fall var(--dur) linear infinite;filter:blur(.2px)}
    @keyframes fall{to{transform:translateY(120vh) translateX(12vw);opacity:0}}

    /* shaking animation */
    .shaking{animation:shake 800ms ease-in-out}
    @keyframes shake{20%{transform:translateX(-6px) rotate(-2deg)}40%{transform:translateX(6px) rotate(2deg)}60%{transform:translateX(-4px) rotate(-1deg)}80%{transform:translateX(2px) rotate(1deg)}100%{transform:translateX(0) rotate(0)}}

    /* small UI */
    .hint{margin-top:12px;font-size:13px;opacity:.9}
    .controls{display:flex;gap:8px;margin-top:14px}
    .btn{background:transparent;border:1px solid rgba(255,255,255,0.08);padding:8px 12px;border-radius:10px;color:inherit;cursor:pointer}

    footer{margin-top:12px;color:rgba(230,238,248,0.6);font-size:13px;text-align:center}

    /* responsive tweaks */
    @media (max-width:520px){
      :root{ --glass-size: min(86vmin,360px); }
      .globe-inner{ width:74%; height:74%; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Тайный Санта — Открытка</h1>
      <p class="lead">Потряси телефон или нажми на шар — внутри появится сюрприз!</p>

      <div class="globe-stage">
        <div id="globe" class="globe" role="button" tabindex="0" title="Нажми или потряси">
          <div class="globe-inner" id="globeInner">
            <!-- image inserted here -->
            <img id="mainImage" src="images/placeholder.png" alt="подарок" style="opacity:0">
          </div>

          <div id="snowLayer" class="snow-layer" aria-hidden="true"></div>
        </div>
      </div>

      <div class="hint">Если ничего не происходит — нажми на шар или кнопку «Потрясти».</div>
      <div class="controls">
        <button id="shakeBtn" class="btn">Потрясти</button>
        <button id="allowMotion" class="btn">Включить доступ к датчику движения</button>
      </div>

      <footer>Сделано с любовью — просто загрузите папку на статический хостинг и разошлите QR.</footer>
    </div>
  </div>

  <script>
    // --- CONFIG: если поменяешь имена картинок, укажи количество ---
    const IMAGES_COUNT = 20; // <- Укажи, сколько у тебя картинок (img1..imgN)
    const IMAGE_PREFIX = 'images/img'; // final becomes images/img1.jpg etc
    const IMAGE_EXT = '.jpg'; // .jpg or .png or .webp as you prefer
    // ------------------------------------------------------------

    const globe = document.getElementById('globe');
    const mainImage = document.getElementById('mainImage');
    const snowLayer = document.getElementById('snowLayer');
    const shakeBtn = document.getElementById('shakeBtn');
    const allowMotion = document.getElementById('allowMotion');

    let lastShown = -1;
    let isBusy = false;

    // Utility: pick a random image index not equal to lastShown (prefer different)
    function pickRandomIndex(){
      if(IMAGES_COUNT <= 1) return 1;
      let idx;
      let attempts = 0;
      do{ idx = Math.floor(Math.random()*IMAGES_COUNT)+1; attempts++; } while(idx===lastShown && attempts<6);
      lastShown = idx;
      return idx;
    }

    function showRandomImage(){
      const idx = pickRandomIndex();
      const url = IMAGE_PREFIX + idx + IMAGE_EXT;
      // preload
      const img = new Image();
      img.onload = ()=>{
        mainImage.src = url;
        mainImage.style.opacity = 1;
        mainImage.style.transform = 'scale(1)';
      };
      img.onerror = ()=>{
        // in case image missing, show placeholder and console log
        mainImage.src = 'images/placeholder.png';
        mainImage.style.opacity = 1;
        console.warn('Не удалось загрузить', url);
      };
      img.src = url;
    }

    // Snow generator
    function createSnow(count = 30){
      snowLayer.innerHTML = '';
      for(let i=0;i<count;i++){
        const f = document.createElement('div');
        f.className = 'flake';
        const size = Math.random()*6 + 3; // px
        f.style.width = size + 'px'; f.style.height = size + 'px';
        f.style.left = Math.random()*100 + '%';
        f.style.opacity = 0.6 + Math.random()*0.4;
        f.style.background = 'white';
        f.style.setProperty('--dur', (4 + Math.random()*3) + 's');
        f.style.transform = `translateY(-10vh) translateX(0)`;
        snowLayer.appendChild(f);
      }
    }

    // Trigger animation: shaking + snow + image reveal
    function triggerEffect(){
      if(isBusy) return; isBusy = true;
      // reset image opacity for nice fade-in
      mainImage.style.opacity = 0; mainImage.style.transform='scale(.96) translateY(4px)';

      globe.classList.add('shaking');
      createSnow(36);
      // show random image after 600ms
      setTimeout(()=>{
        showRandomImage();
      }, 600);
      // stop shaking and clear snow after 1800ms
      setTimeout(()=>{
        globe.classList.remove('shaking');
        snowLayer.innerHTML = '';
        isBusy = false;
      }, 2200);
    }

    // fallback: click / tap globe
    globe.addEventListener('click', ()=>{ triggerEffect(); });
    shakeBtn.addEventListener('click', ()=>{ triggerEffect(); });

    // Motion / shake detection for mobile
    let lastX=null, lastY=null, lastZ=null;
    let shakeThreshold = 18; // tweak sensitivity
    function handleMotion(e){
      const a = e.accelerationIncludingGravity || e.acceleration || {x:0,y:0,z:0};
      const x = a.x || 0; const y = a.y || 0; const z = a.z || 0;
      if(lastX===null){ lastX=x; lastY=y; lastZ=z; return; }
      const dx = Math.abs(x-lastX), dy = Math.abs(y-lastY), dz = Math.abs(z-lastZ);
      lastX=x; lastY=y; lastZ=z;
      if((dx+dy+dz) > shakeThreshold){ triggerEffect(); }
    }

    // Permission request (iOS 13+)
    allowMotion.addEventListener('click', async ()=>{
      if(typeof(DeviceMotionEvent) !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function'){
        try{
          const resp = await DeviceMotionEvent.requestPermission();
          if(resp === 'granted'){
            window.addEventListener('devicemotion', handleMotion);
            allowMotion.style.display = 'none';
            alert('Доступ к датчику движения включен — теперь можно потрясти телефон.');
          } else {
            alert('Доступ к датчику движения не разрешён. Используйте кнопку Потрясти.');
          }
        }catch(err){ console.warn(err); alert('Не удалось запросить разрешение.'); }
      } else {
        // desktop or older devices
        window.addEventListener('devicemotion', handleMotion);
        allowMotion.style.display = 'none';
        alert('Датчик движения доступен (если поддерживается). Попробуйте потрясти устройство.');
      }
    });

    // Also try to auto-bind devicemotion on supporting browsers (won't work on iOS without permission)
    try{ window.addEventListener('devicemotion', handleMotion); }catch(e){}

    // Init placeholder
    document.addEventListener('DOMContentLoaded', ()=>{
      mainImage.src = 'images/placeholder.png';
      mainImage.style.opacity = 1;
    });

    // keyboard accessibility: Enter/Space triggers
    globe.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter' || ev.key===' ') { ev.preventDefault(); triggerEffect(); } });

  </script>
</body>
</html>
